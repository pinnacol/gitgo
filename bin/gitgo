#!/usr/bin/env ruby

lib_dir = File.expand_path(File.join(File.dirname(__FILE__), "../lib"))
$:.unshift(lib_dir) unless $:.include?(lib_dir)

# Launches a Gitgo server.
require 'rubygems'
require 'optparse'
require 'gitgo'

options = {
  :host => '127.0.0.1', 
  :port => 8080,
  :repo => ".",
  :branch => "gitgo"
}

OptionParser.new do |opts|
  opts.separator ""
  opts.separator "Options:"
  
  opts.on("-h", "--host=HOST", "The ci server host (#{options[:host]})") do |host|
    options[:host] = host
  end
  
  opts.on("-p", "--port=PORT", "The ci server port (#{options[:port]})") do |port|
    options[:port] = port.to_i
  end
  
  opts.on("-r", "--repo=REPO", "The path to the repo (#{options[:repo]})") do |repo|
    options[:repo] = repo
  end
  
  opts.on("-b", "--branch=BRANCH", "The gitgo branch (#{options[:branch]})") do |branch|
    options[:branch] = branch
  end
  
  opts.on("-h", "--help", "Prints this help") do |ports|
    lines = File.readlines(__FILE__)
    lines.shift                             # skip shebang
    lines.shift while lines[0].strip.empty? # skip spaces
    
    puts "#" * 80
    lines.each do |line|
      break unless line =~ /#\s+(.*)/
      puts($1)
    end
    puts "#" * 80
    puts opts
  end
end.parse!

options[:repo] = Gitgo::Repo.init(options[:repo], options)
Gitgo::Server.run!(options)