#!/usr/bin/env ruby

require 'optparse'

begin
  require 'gitgo'
rescue(LoadError)
  # assume development if gitgo cannot be found
  require 'vendor/gems/environment'
  require 'gitgo'
end

options = {
  :host => '127.0.0.1', 
  :port => 8080,
  :repo => ".",
  :branch => "gitgo",
  :sessions => false
}

OptionParser.new do |opts|
  opts.banner = "usage: gitgo [options]"
  opts.separator ""
  opts.separator "options:"
  
  opts.on("-h", "--host=HOST", "The server host (#{options[:host]})") do |host|
    options[:host] = host
  end
  
  opts.on("-p", "--port=PORT", "The server port (#{options[:port]})") do |port|
    options[:port] = port.to_i
  end
  
  opts.on("-r", "--repo=REPO", "The path to the repo (#{options[:repo]})") do |repo|
    options[:repo] = repo
  end
  
  opts.on("-b", "--branch=BRANCH", "The gitgo branch (#{options[:branch]})") do |branch|
    options[:branch] = branch
  end
  
  opts.on("-s", "--sessions", "Use cookie sessions (#{options[:sessions]})") do
    options[:sessions] = true
  end
  
  opts.on("-h", "--help", "Prints this help") do |ports|
    puts opts
    exit(0)
  end
  
  opts.separator ""
  opts.separator "version #{Gitgo::VERSION} -- #{Gitgo::WEBSITE}"
end.parse!

options[:repo] = Gitgo::Repo.init(options[:repo], options)
Gitgo::Server.set(:sessions, options[:sessions])
Gitgo::Server.run!(options)